<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily SE Tool</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#028b43">

  <!-- SheetJS (XLSX export) - CDN with fallback -->
  <script>
    (function loadXLSX(){
      function addScript(src, onload, onerror){
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = onload;
        s.onerror = onerror;
        document.head.appendChild(s);
      }

      // Primary CDN
      addScript(
        "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",
        function(){ console.log("XLSX loaded from jsDelivr"); },
        function(){
          console.warn("jsDelivr failed, trying SheetJS CDN...");
          // Fallback CDN
          addScript(
            "https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js",
            function(){ console.log("XLSX loaded from SheetJS CDN"); },
            function(){ console.error("Both XLSX CDNs failed."); }
          );
        }
      );
    })();
  </script>

  <style>
:root{
  --beige:#f6f3dd;
  --green:#028b43;
  --orange:#f8a925;
  --bg:var(--beige);
  --text:#0b1220;
  --muted:#475569;
  --card:#ffffff;
  --border:#e5e7eb;
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:600px;
  margin:auto;
  padding:15px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

h2{ margin-top:0; }

label{
  font-size:14px;
  font-weight:bold;
}

input, select, textarea{
  width:100%;
  padding:10px;
  margin-top:5px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
  box-sizing:border-box;
  font-family: inherit;
}

textarea{ resize: vertical; min-height: 70px; }

button{
  padding:10px 15px;
  border-radius:20px;
  border:none;
  font-weight:bold;
  cursor:pointer;
}

.btn-primary{ background:var(--green); color:white; }
.btn-orange{ background:var(--orange); color:black; }

.btn-secondary{
  background:white;
  border:1px solid var(--border);
}

.flex{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.table-container{ overflow-x:auto; }

table{
  border-collapse:collapse;
  width:100%;
  font-size:13px;
}

th, td{
  padding:8px;
  border:1px solid var(--border);
  text-align:left;
  vertical-align:top;
}

th{ background:#eee5d8; }

.error{ color:red; font-size:13px; }
.warning{ color:#b45309; font-size:13px; }
.small{ font-size:12px; color:var(--muted); }
hr.sep{ border:none; border-top:1px solid var(--border); margin:12px 0; }

.badge{
  display:inline-block;
  padding:2px 8px;
  border:1px solid var(--border);
  border-radius:999px;
  font-size:12px;
  background:#fff;
  color:var(--muted);
}

/* Emphasize Financial Data */
.financial-card{
  border:2px solid var(--green);
  border-radius:18px;
  padding:14px;
  background:#ffffff;
  box-shadow:0 6px 14px rgba(2,139,67,0.10);
  margin-top:12px;
}
.financial-title{
  font-size:16px;
  font-weight:800;
  margin:0 0 10px;
}
  </style>
</head>

<body>
  <div class="container">

    <div class="card">
      <h2>Daily SE Tool</h2>
      <p class="small">
        This tool helps you record daily sales and related variables for Sales Executive (SE).
        Please submit the completed table each day to the S&amp;M Manager via WhatsApp or email.
      </p>
      <p class="small" id="offlineNote"></p>
    </div>

    <!-- Global Interface -->
    <div class="card" id="globalCard">
      <h2>Global Interface</h2>

      <label for="globalDate">Date</label>
      <input id="globalDate" type="date" />

      <label for="seName">SE Name</label>
      <select id="seName">
        <option value="JimFred Kaboyo">JimFred Kaboyo</option>
        <option value="SE 2">SE 2</option>
        <option value="SE 3">SE 3</option>
        <option value="SE 4">SE 4</option>
      </select>

      <label for="mode">Mode</label>
      <select id="mode">
        <option value="newClient">New Client</option>
        <option value="order">Order</option>
        <option value="payment">Payment</option>
      </select>

      <p class="warning" id="warnMsg"></p>
      <p class="error" id="errorMsg"></p>
    </div>

    <!-- Form Card -->
    <div class="card" id="formCard">
      <h2 id="formTitle">New Client</h2>

      <!-- NEW CLIENT FORM -->
      <div id="newClientForm">

        <label for="ncDistrict">District</label>
        <select id="ncDistrict">
          <option value="Buliisa">Buliisa</option>
          <option value="Hoima">Hoima</option>
          <option value="Masindi">Masindi</option>
          <option value="Other">Other</option>
        </select>

        <label id="parishLabel">Parish</label>

        <select id="ncParishHoima" style="display:none;">
          <option value="">Select ward (Hoima)</option>
          <option>Bujuura ward</option>
          <option>Bwikya ward</option>
          <option>Central ward Hoima</option>
          <option>Karongo ward</option>
          <option>Kasingo ward</option>
          <option>Kibingo ward</option>
          <option>Kibugubya</option>
          <option>Kicwamba ward</option>
          <option>Kiduuma ward</option>
          <option>Kihombooza ward</option>
          <option>Kihuukya ward</option>
          <option>Kyentale ward</option>
          <option>Kyesiiga ward</option>
          <option>Northern ward Hoima</option>
          <option>Nyakambugu ward</option>
          <option>Southern ward Hoima</option>
          <option>Western ward Hoima</option>
        </select>

        <input id="ncParishText" type="text" style="display:none;" placeholder="Type parish" />

        <label for="ncType">Client Type</label>
        <select id="ncType">
          <option value="Corporate employee">Corporate employee</option>
          <option value="Eatery">Eatery</option>
          <option value="Individual">Individual</option>
          <option value="Institution">Institution</option>
          <option value="Restaurant">Restaurant</option>
          <option value="Retailer">Retailer</option>
          <option value="School - Canteen">School - Canteen</option>
          <option value="School - Menu">School - Menu</option>
          <option value="School Other">School Other</option>
        </select>

        <div id="individualDigitWrap" style="display:none;">
          <label for="ncIndDigit">Individual Code (Second Digit 7–9)</label>
          <select id="ncIndDigit">
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
          <p class="small">Individuals use codes 7–9 as the 2nd digit.</p>
        </div>

        <label>Client ID (auto prefix + manual last 3 digits)</label>
        <div class="flex" style="align-items:flex-end;">
          <div style="flex:1; min-width:160px;">
            <label for="ncPrefix" class="small">Prefix (auto)</label>
            <input id="ncPrefix" type="text" readonly />
          </div>
          <div style="flex:1; min-width:160px;">
            <label for="ncLast3" class="small">Last 3 digits (XXX)</label>
            <input id="ncLast3" type="text" inputmode="numeric" maxlength="3" placeholder="e.g. 001" />
          </div>
          <div style="flex:1; min-width:160px;">
            <label for="ncClientId" class="small">Full Client ID</label>
            <input id="ncClientId" type="text" readonly />
          </div>
        </div>

        <label for="ncClientName">Client Name</label>
        <input id="ncClientName" type="text" placeholder="Client name" />

        <label for="ncLevel">Level</label>
        <select id="ncLevel">
          <option value="N+1">N+1</option>
          <option value="N+2">N+2</option>
          <option value="N+3">N+3</option>
        </select>
        <p class="small">Auto-set by type (Retailer→N+1, Schools/Restaurant/Eatery/Corporate/Institution→N+2, Individual→N+3) but editable.</p>

        <label for="ncContact">Contact</label>
        <input id="ncContact" type="text" placeholder="Phone / name / contact info" />

        <div id="statusEnrollWrap">
          <label for="ncStatus">Status</label>
          <select id="ncStatus">
            <option value="Active">Active</option>
            <option value="On hold">On hold</option>
            <option value="Quit">Quit</option>
          </select>

          <label for="ncEnrollDate">Enrollment Date</label>
          <input id="ncEnrollDate" type="date" />
        </div>
      </div>

      <!-- ORDER FORM -->
      <div id="orderForm" style="display:none;">
        <label for="ordClientId">Client ID (select or type)</label>
        <input id="ordClientId" list="clientIdList" placeholder="Choose or type Client ID" />
        <datalist id="clientIdList"></datalist>

        <p class="small">
          Note: Blank 1 and Blank 2 columns will appear empty in the Orders table and XLSX export.
        </p>

        <label for="ordDate">Date of Order</label>
        <input id="ordDate" type="date" />

        <label for="ordDeliveryDate">Date of Delivery</label>
        <input id="ordDeliveryDate" type="date" />

        <label for="ordDeliveryTime">Time of Delivery</label>
        <input id="ordDeliveryTime" type="time" />

        <label for="ordLocation">Location of Delivery</label>
        <input id="ordLocation" type="text" placeholder="Type location" />

        <label for="ordProduct">Type of Product</label>
        <select id="ordProduct">
          <option value="Fried tofu (kg)">Fried tofu (kg)</option>
          <option value="Fresh tofu (kg)">Fresh tofu (kg)</option>
          <option value="Kikalayi (kg)">Kikalayi (kg)</option>
          <option value="Kikalayi (portion)">Kikalayi (portion)</option>
          <option value="Skewers (portion)">Skewers (portion)</option>
        </select>

        <label for="ordQty">Quantity</label>
        <input id="ordQty" type="number" step="0.001" placeholder="Enter quantity" />

        <label for="ordUnitPrice">Unit price (UGX) (auto, but editable)</label>
        <input id="ordUnitPrice" type="number" step="1" />

        <label for="ordDiscType">Type of discount</label>
        <select id="ordDiscType">
          <option value="%">%</option>
          <option value="UGX">UGX</option>
        </select>

        <div class="flex">
          <div style="flex:1; min-width:220px;">
            <label for="ordDiscPct">Discount (%)</label>
            <input id="ordDiscPct" type="number" step="0.01" placeholder="Enter discount %" />
          </div>
          <div style="flex:1; min-width:220px;">
            <label for="ordDiscUgx">Discount (UGX)</label>
            <input id="ordDiscUgx" type="number" step="1" placeholder="Enter discount UGX" />
          </div>
        </div>

        <!-- Indicative summary (not in table) -->
        <div class="financial-card" style="margin-top:6px;">
          <div class="financial-title">Order Price Summary (Indicative)</div>
          <div class="small">Price before discount: <span id="ordBefore">0</span> UGX</div>
          <div class="small">Discount: <span id="ordDiscShow">0</span></div>
          <div class="small">Price after discount: <span id="ordAfter">0</span> UGX</div>
        </div>
      </div>

      <!-- PAYMENT FORM (replaces SALE) -->
      <div id="paymentForm" style="display:none;">
        <label for="payClientId">Client ID (select or type)</label>
        <input id="payClientId" list="clientIdList" placeholder="Choose or type Client ID" />

        <label for="payOrderNumber">Order Number</label>
        <input id="payOrderNumber" type="text" placeholder="Enter order number" />

        <label for="payProduct">Product</label>
        <select id="payProduct">
          <option value="Fried tofu (kg)">Fried tofu (kg)</option>
          <option value="Fresh tofu (kg)">Fresh tofu (kg)</option>
          <option value="Kikalayi (kg)">Kikalayi (kg)</option>
          <option value="Kikalayi (portion)">Kikalayi (portion)</option>
          <option value="Skewers (portion)">Skewers (portion)</option>
        </select>

        <label for="payUnitPrice">Unit Price (auto, but editable)</label>
        <input id="payUnitPrice" type="number" step="1" />

        <div class="flex">
          <div style="flex:1; min-width:220px;">
            <label for="payQtyKg">Quantity (kg)</label>
            <input id="payQtyKg" type="number" step="0.001" placeholder="Enter kg" />
          </div>
          <div style="flex:1; min-width:220px;">
            <label for="payQtyPortion">Quantity (portion)</label>
            <input id="payQtyPortion" type="number" step="0.001" placeholder="Enter portions" />
          </div>
        </div>
        <p class="small">For tofu: 1 portion = 1 kg. Kikalayi: 0.04 kg/portion. Skewers: 0.045 kg/portion.</p>

        <div class="financial-card">
          <div class="financial-title">Financial Data</div>

          <label for="payExpected">Expected Cash Collected (auto)</label>
          <input id="payExpected" type="number" readonly />

          <label for="payActual">Actual Cash Collected (to be filled)</label>
          <input id="payActual" type="number" step="1" placeholder="Enter actual cash" />

          <label for="payDiscrepancy">Discrepancy (Expected - Actual) (auto)</label>
          <input id="payDiscrepancy" type="number" readonly />

          <label for="payComment">Comment</label>
          <textarea id="payComment" placeholder="Write a comment..."></textarea>
        </div>
      </div>

      <div class="flex">
        <button class="btn-primary" id="recordBtn">Record Data</button>
        <button class="btn-secondary" id="resetBtn">Reset Form</button>
        <button class="btn-secondary" id="backBtn">Go Back to Global Interface</button>
      </div>

      <p class="error" id="formError"></p>
      <p class="warning" id="formWarn"></p>
    </div>

    <!-- Records Card -->
    <div class="card">
      <h2>Records</h2>

      <div class="flex">
        <button class="btn-orange" id="exportBtn">Export XLSX</button>
      </div>

      <h3 style="margin-bottom:6px;">Clients</h3>
      <div class="flex" style="margin-bottom:8px;">
        <button class="btn-secondary" id="resetClientsBtn">Reset Clients Table</button>
      </div>
      <div class="table-container">
        <table id="clientsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>SE Name</th>
              <th>Client ID</th>
              <th>Client name</th>
              <th>Client type</th>
              <th>Level</th>
              <th>District</th>
              <th>Parish</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Enrollment date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:14px 0 6px;">Orders</h3>
      <div class="flex" style="margin-bottom:8px;">
        <button class="btn-secondary" id="resetOrdersBtn">Reset Orders Table</button>
      </div>
      <div class="table-container">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>SE Name</th>
              <th>Client ID</th>
              <th>Blank 1</th>
              <th>Blank 2</th>
              <th>Date of order</th>
              <th>Date of delivery</th>
              <th>Time of delivery</th>
              <th>Location of delivery</th>
              <th>Type of product</th>
              <th>Quantity</th>
              <th>Unit price (UGX)</th>
              <th>Type of discount</th>
              <th>Discount (%)</th>
              <th>Discount (UGX)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <h3 style="margin:14px 0 6px;">Payments</h3>
      <div class="flex" style="margin-bottom:8px;">
        <button class="btn-secondary" id="resetPaymentsBtn">Reset Payments Table</button>
      </div>
      <div class="table-container">
        <table id="paymentsTable">
          <thead>
            <tr>
              <th>SE Name</th>
              <th>Date</th>
              <th>Client ID</th>
              <th>Order Number</th>
              <th>Product</th>
              <th>Unit Price</th>
              <th>Qty (kg)</th>
              <th>Qty (portion)</th>
              <th>Expected</th>
              <th>Actual</th>
              <th>Discrepancy</th>
              <th>Comment</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px;">Data is saved in your browser (localStorage).</p>
    </div>

  </div>

<script>
/* =========================
   Offline (Service Worker)
========================= */
(async function registerSW(){
  const note = document.getElementById("offlineNote");
  if(!("serviceWorker" in navigator)){
    note.textContent = "Offline mode: Not supported on this browser.";
    return;
  }
  try{
    await navigator.serviceWorker.register("./service-worker.js");
    note.textContent = "Offline mode: This app will work offline after the first load (keep it opened once while online).";
  }catch(e){
    console.warn("SW register failed", e);
    note.textContent = "Offline mode: Service worker registration failed (check hosting on HTTPS/localhost).";
  }
})();

/* =========================
   Storage + State
========================= */
const STORAGE_KEY = "daily_se_tool_v2";

// Keep existing "sales" storage but use it as "payments" (backward compatible)
let state = { clients: [], orders: [], sales: [] };

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      state.clients = Array.isArray(parsed.clients) ? parsed.clients : [];
      state.orders  = Array.isArray(parsed.orders)  ? parsed.orders  : [];
      state.sales   = Array.isArray(parsed.sales)   ? parsed.sales   : [];
    }
  }catch(e){
    console.warn("Failed to load state", e);
  }
}

function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* =========================
   Helpers
========================= */
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function setText(id, text){ document.getElementById(id).textContent = text || ""; }
function show(el){ el.style.display = ""; }
function hide(el){ el.style.display = "none"; }
function isValid3Digits(s){ return /^[0-9]{3}$/.test(String(s || "").trim()); }

// "HH:MM" -> "H:MMAM"/"H:MMPM" (no space)
function toAmPm(hhmm){
  const t = String(hhmm || "").trim();
  const m = t.match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return "";
  let h = Number(m[1]);
  const min = m[2];
  if(!Number.isFinite(h)) return "";
  const suffix = h >= 12 ? "PM" : "AM";
  h = h % 12;
  if(h === 0) h = 12;
  return `${h}:${min}${suffix}`;
}

/*
Client digit scheme (C-XXXXX):
- 1xxxx Hoima, 2xxxx Buliisa, 3xxxx Masindi, 0xxxx Other
- Second digit is type:
  1 schools, 2 retailers, 3 restaurants, 4 eateries, 5 corporate employees, 6 institutions, 7-9 individuals
- Last 3 digits are manual (XXX)
*/
function districtDigit(district){
  if(district === "Hoima") return "1";
  if(district === "Buliisa") return "2";
  if(district === "Masindi") return "3";
  return "0";
}
function typeDigit(type){
  if(type === "School - Menu" || type === "School - Canteen" || type === "School Other") return "1";
  if(type === "Retailer") return "2";
  if(type === "Restaurant") return "3";
  if(type === "Eatery") return "4";
  if(type === "Corporate employee") return "5";
  if(type === "Institution") return "6";
  return "";
}
function autoLevelByType(type){
  if(type === "Retailer") return "N+1";
  if(
    type === "School - Menu" ||
    type === "School - Canteen" ||
    type === "School Other" ||
    type === "Restaurant" ||
    type === "Eatery" ||
    type === "Corporate employee" ||
    type === "Institution"
  ) return "N+2";
  if(type === "Individual") return "N+3";
  return "N+2";
}
function ratioKgPerPortion(product){
  if(product === "Kikalayi (portion)" || product === "Kikalayi (kg)") return 0.04;
  if(product === "Skewers (portion)") return 0.045;
  if(product === "Fresh tofu (kg)" || product === "Fried tofu (kg)") return 1.0;
  return 1.0;
}
function isRetailerClientId(clientId){
  const id = String(clientId || "").trim();
  return /^C-[0-3]2\d{3}$/.test(id);
}
function defaultUnitPrice(product, clientId){
  const retailer = isRetailerClientId(clientId);
  if(product === "Fresh tofu (kg)") return retailer ? 5000 : 6000;
  if(product === "Fried tofu (kg)") return retailer ? 6500 : 7500;
  if(product === "Kikalayi (kg)") return 10000;
  if(product === "Kikalayi (portion)") return 500;
  if(product === "Skewers (portion)") return 1000;
  return 0;
}
function toNumber(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}
function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }

function expectedCash(product, unitPriceValue, qtyKg, qtyPortion){
  const price = toNumber(unitPriceValue);
  if(product.includes("(portion)")){
    return price * (toNumber(qtyPortion) || 0);
  }
  return price * (toNumber(qtyKg) || 0);
}

/* =========================
   Elements
========================= */
const globalDate = document.getElementById("globalDate");
const seName = document.getElementById("seName");
const mode = document.getElementById("mode");

const newClientForm = document.getElementById("newClientForm");
const orderForm = document.getElementById("orderForm");
const paymentForm = document.getElementById("paymentForm");
const formTitle = document.getElementById("formTitle");

const recordBtn = document.getElementById("recordBtn");
const resetBtn = document.getElementById("resetBtn");
const backBtn = document.getElementById("backBtn");
const exportBtn = document.getElementById("exportBtn");

const resetClientsBtn = document.getElementById("resetClientsBtn");
const resetOrdersBtn = document.getElementById("resetOrdersBtn");
const resetPaymentsBtn = document.getElementById("resetPaymentsBtn");

const formError = document.getElementById("formError");
const formWarn = document.getElementById("formWarn");

// New client inputs
const ncDistrict = document.getElementById("ncDistrict");
const ncType = document.getElementById("ncType");
const ncIndDigitWrap = document.getElementById("individualDigitWrap");
const ncIndDigit = document.getElementById("ncIndDigit");
const ncPrefix = document.getElementById("ncPrefix");
const ncLast3 = document.getElementById("ncLast3");
const ncClientId = document.getElementById("ncClientId");
const ncClientName = document.getElementById("ncClientName");
const ncLevel = document.getElementById("ncLevel");
const ncParishHoima = document.getElementById("ncParishHoima");
const ncParishText = document.getElementById("ncParishText");
const ncContact = document.getElementById("ncContact");
const statusEnrollWrap = document.getElementById("statusEnrollWrap");
const ncStatus = document.getElementById("ncStatus");
const ncEnrollDate = document.getElementById("ncEnrollDate");

// Order inputs
const ordClientId = document.getElementById("ordClientId");
const ordDate = document.getElementById("ordDate");
const ordDeliveryDate = document.getElementById("ordDeliveryDate");
const ordDeliveryTime = document.getElementById("ordDeliveryTime");
const ordLocation = document.getElementById("ordLocation");
const ordProduct = document.getElementById("ordProduct");
const ordQty = document.getElementById("ordQty");
const ordUnitPrice = document.getElementById("ordUnitPrice");
const ordDiscType = document.getElementById("ordDiscType");
const ordDiscPct = document.getElementById("ordDiscPct");
const ordDiscUgx = document.getElementById("ordDiscUgx");
const ordBefore = document.getElementById("ordBefore");
const ordDiscShow = document.getElementById("ordDiscShow");
const ordAfter = document.getElementById("ordAfter");

// Payment inputs
const payClientId = document.getElementById("payClientId");
const payOrderNumber = document.getElementById("payOrderNumber");
const payProduct = document.getElementById("payProduct");
const payUnitPrice = document.getElementById("payUnitPrice");
const payQtyKg = document.getElementById("payQtyKg");
const payQtyPortion = document.getElementById("payQtyPortion");
const payExpected = document.getElementById("payExpected");
const payActual = document.getElementById("payActual");
const payDiscrepancy = document.getElementById("payDiscrepancy");
const payComment = document.getElementById("payComment");

const clientIdList = document.getElementById("clientIdList");

/* =========================
   UI Logic
========================= */
function setModeUI(){
  setText("warnMsg", "");
  setText("errorMsg", "");
  setText("formWarn", "");
  setText("formError", "");

  const m = mode.value;
  hide(newClientForm); hide(orderForm); hide(paymentForm);

  if(m === "newClient"){
    formTitle.textContent = "New Client";
    show(newClientForm);
  }else if(m === "order"){
    formTitle.textContent = "Order";
    show(orderForm);
  }else{
    formTitle.textContent = "Payment";
    show(paymentForm);
  }
}

function updateParishUI(){
  if(ncDistrict.value === "Hoima"){
    show(ncParishHoima);
    hide(ncParishText);
  }else{
    hide(ncParishHoima);
    show(ncParishText);
  }
}

function updateClientIdPrefix(){
  const d1 = districtDigit(ncDistrict.value);
  const type = ncType.value;

  if(type === "Individual"){
    show(ncIndDigitWrap);
    const d2 = String(ncIndDigit.value);
    ncPrefix.value = `C-${d1}${d2}`;
  }else{
    hide(ncIndDigitWrap);
    const d2 = typeDigit(type);
    ncPrefix.value = `C-${d1}${d2}`;
  }

  ncLevel.value = autoLevelByType(type);

  if(type === "Individual"){
    hide(statusEnrollWrap);
  }else{
    show(statusEnrollWrap);
  }

  updateFullClientId();
}

function updateFullClientId(){
  const last3 = String(ncLast3.value || "").trim();
  const prefix = String(ncPrefix.value || "").trim(); // "C-12"
  const m = prefix.match(/^C-(\d{2})$/);
  if(m && /^[0-9]{0,3}$/.test(last3)){
    const digits = (m[1] + last3).padEnd(5, "");
    ncClientId.value = `C-${digits}`;
  }else{
    ncClientId.value = "";
  }
}

function rebuildClientIdDatalist(){
  const ids = new Set();
  state.clients.forEach(c => ids.add(String(c.clientId)));
  clientIdList.innerHTML = "";
  [...ids].sort().forEach(id => {
    const opt = document.createElement("option");
    opt.value = id;
    clientIdList.appendChild(opt);
  });
}

/* =========================
   ORDER: Unit price + discount calculations
========================= */
let orderPriceOverridden = false;
let orderDiscLock = false;

function applyDefaultOrderPriceIfNotOverridden(){
  if(orderPriceOverridden) return;
  const cid = ordClientId.value.trim();
  const prod = ordProduct.value;
  ordUnitPrice.value = defaultUnitPrice(prod, cid);
}

function calcOrderBefore(){
  const qty = toNumber(ordQty.value);
  const price = toNumber(ordUnitPrice.value);
  return round2(qty * price);
}

function updateOrderDiscountAndSummary(source){
  if(orderDiscLock) return;
  orderDiscLock = true;

  const before = calcOrderBefore();
  const type = ordDiscType.value;

  let pct = toNumber(ordDiscPct.value);
  let ugx = toNumber(ordDiscUgx.value);

  if(before <= 0){
    ordBefore.textContent = "0";
    ordDiscShow.textContent = "0";
    ordAfter.textContent = "0";
    orderDiscLock = false;
    return;
  }

  if(type === "%"){
    if(source === "ugx") {
      pct = (ugx / before) * 100;
      ordDiscPct.value = round2(pct);
    }
    ugx = (toNumber(ordDiscPct.value) / 100) * before;
    ordDiscUgx.value = round2(ugx);
  }else{
    if(source === "pct") {
      ugx = (pct / 100) * before;
      ordDiscUgx.value = round2(ugx);
    }
    pct = (toNumber(ordDiscUgx.value) / before) * 100;
    ordDiscPct.value = round2(pct);
  }

  const finalUgx = Math.max(0, before - toNumber(ordDiscUgx.value));
  ordBefore.textContent = String(round2(before));
  ordAfter.textContent = String(round2(finalUgx));

  const showPct = round2(toNumber(ordDiscPct.value));
  const showUgx = round2(toNumber(ordDiscUgx.value));
  ordDiscShow.textContent = type === "%" ? `${showPct}% (${showUgx} UGX)` : `${showUgx} UGX (${showPct}%)`;

  orderDiscLock = false;
}

/* =========================
   PAYMENT: unit price + qty sync + financial calcs
========================= */
let payLock = false;
let payPriceOverridden = false;

function applyDefaultPayPriceIfNotOverridden(){
  if(payPriceOverridden) return;
  const cid = payClientId.value.trim();
  const prod = payProduct.value;
  payUnitPrice.value = defaultUnitPrice(prod, cid);
}

function updatePaymentCalcs(){
  const prod = payProduct.value;
  const kg = toNumber(payQtyKg.value);
  const portion = toNumber(payQtyPortion.value);

  const exp = expectedCash(prod, payUnitPrice.value, kg, portion);
  payExpected.value = round2(exp);

  const actual = toNumber(payActual.value);
  const disc = exp - actual;
  payDiscrepancy.value = round2(disc);
}

function syncPayKgFromPortion(){
  if(payLock) return;
  payLock = true;
  const ratio = ratioKgPerPortion(payProduct.value);
  const p = toNumber(payQtyPortion.value);
  payQtyKg.value = round2(p * ratio);
  payLock = false;
  updatePaymentCalcs();
}

function syncPayPortionFromKg(){
  if(payLock) return;
  payLock = true;
  const ratio = ratioKgPerPortion(payProduct.value);
  const kg = toNumber(payQtyKg.value);
  payQtyPortion.value = ratio === 0 ? "" : round2(kg / ratio);
  payLock = false;
  updatePaymentCalcs();
}

/* =========================
   Record Actions
========================= */
function validateGlobal(){
  const date = globalDate.value;
  const se = seName.value.trim();
  if(!date) return "Please select a date.";
  if(!se) return "Please enter SE Name.";
  return "";
}

function recordNewClient(){
  const err = validateGlobal();
  if(err) return err;

  const district = ncDistrict.value;
  const type = ncType.value;

  const prefix = ncPrefix.value.trim(); // "C-12"
  const last3 = ncLast3.value.trim();
  if(!/^C-\d{2}$/.test(prefix)) return "Client ID prefix is not valid.";
  if(!isValid3Digits(last3)) return "Please enter the last 3 digits (XXX) as exactly 3 numbers (e.g., 001).";

  const clientId = `${prefix}${last3}`; // C-12XXX

  const clientName = ncClientName.value.trim();
  if(!clientName) return "Please enter Client Name.";

  const level = ncLevel.value;

  let parish = "";
  if(district === "Hoima"){
    parish = ncParishHoima.value.trim();
    if(!parish) return "Please select a parish (ward) for Hoima.";
  }else{
    parish = ncParishText.value.trim();
    if(!parish) return "Please type the parish for this district.";
  }

  const contact = ncContact.value.trim();
  if(type !== "Individual" && !contact){
    return "Please enter Contact (required for non-individual clients).";
  }

  let status = "";
  let enrollDate = "";
  if(type !== "Individual"){
    status = ncStatus.value;
    enrollDate = ncEnrollDate.value;
    if(!enrollDate) return "Please choose Enrollment Date.";
  }

  state.clients.push({
    date: globalDate.value,
    seName: seName.value.trim(),
    clientId,
    clientName,
    clientType: type,
    level,
    district,
    parish,
    contact,
    status,
    enrollmentDate: enrollDate
  });

  saveState();
  renderAll();
  rebuildClientIdDatalist();
  return "";
}

function recordOrder(){
  const err = validateGlobal();
  if(err) return err;

  const cid = ordClientId.value.trim();
  if(!cid) return "Please select or type a Client ID.";

  const dOrder = ordDate.value;
  const dDel = ordDeliveryDate.value;
  if(!dOrder) return "Please choose Date of Order.";
  if(!dDel) return "Please choose Date of Delivery.";

  const tDelRaw = ordDeliveryTime.value;
  if(!tDelRaw) return "Please choose Time of Delivery.";
  const tDel = toAmPm(tDelRaw);
  if(!tDel) return "Time of Delivery is not valid.";

  const loc = ordLocation.value.trim();
  if(!loc) return "Please enter Location of Delivery.";

  const prod = ordProduct.value;

  const qtyRaw = ordQty.value;
  if(qtyRaw === "" || qtyRaw === null) return "Please enter Quantity.";
  const qty = toNumber(qtyRaw);

  const unitPrice = toNumber(ordUnitPrice.value);
  if(unitPrice <= 0) return "Please enter Unit price (UGX).";

  const discType = ordDiscType.value;
  const discPct = round2(toNumber(ordDiscPct.value));
  const discUgx = round2(toNumber(ordDiscUgx.value));

  state.orders.push({
    date: globalDate.value,
    seName: seName.value.trim(),
    clientId: cid,
    blank1: "",
    blank2: "",
    dateOfOrder: dOrder,
    dateOfDelivery: dDel,
    timeOfDelivery: tDel,
    location: loc,
    product: prod,
    quantity: round2(qty),
    unitPrice: round2(unitPrice),
    discountType: discType,
    discountPct: discPct,
    discountUgx: discUgx
  });

  saveState();
  renderAll();
  return "";
}

function recordPayment(){
  const err = validateGlobal();
  if(err) return err;

  const cid = payClientId.value.trim();
  if(!cid) return "Please select or type a Client ID.";

  const orderNo = payOrderNumber.value.trim();
  if(!orderNo) return "Please enter Order Number.";

  const prod = payProduct.value;

  const kg = toNumber(payQtyKg.value);
  const portion = toNumber(payQtyPortion.value);
  if(kg === 0 && portion === 0){
    return "Please enter a quantity in kg or portion.";
  }

  const price = toNumber(payUnitPrice.value);
  const exp = toNumber(payExpected.value);
  const actual = toNumber(payActual.value);
  const disc = toNumber(payDiscrepancy.value);
  const comment = payComment.value || "";

  state.sales.push({
    date: globalDate.value,
    seName: seName.value.trim(),
    clientId: cid,
    orderNumber: orderNo,
    product: prod,
    unitPrice: round2(price),
    qtyKg: round2(kg),
    qtyPortion: round2(portion),
    expected: round2(exp),
    actual: round2(actual),
    discrepancy: round2(disc),
    comment: comment
  });

  saveState();
  renderAll();
  return "";
}

function resetForm(){
  setText("formWarn", "");
  setText("formError", "");

  const m = mode.value;
  if(m === "newClient"){
    ncLast3.value = "";
    ncClientName.value = "";
    ncContact.value = "";
    ncParishHoima.value = "";
    ncParishText.value = "";
    if(ncType.value !== "Individual"){
      ncStatus.value = "Active";
      ncEnrollDate.value = todayISO();
    }
    updateFullClientId();
  }else if(m === "order"){
    ordClientId.value = "";
    ordDate.value = todayISO();
    ordDeliveryDate.value = todayISO();
    ordDeliveryTime.value = "";
    ordLocation.value = "";
    ordProduct.value = "Fried tofu (kg)";
    ordQty.value = "";

    orderPriceOverridden = false;
    ordDiscType.value = "%";
    ordDiscPct.value = "";
    ordDiscUgx.value = "";
    applyDefaultOrderPriceIfNotOverridden();
    updateOrderDiscountAndSummary("type");
  }else{
    payClientId.value = "";
    payOrderNumber.value = "";
    payProduct.value = "Fried tofu (kg)";
    payQtyKg.value = "";
    payQtyPortion.value = "";
    payActual.value = "";
    payComment.value = "";
    payPriceOverridden = false;
    applyDefaultPayPriceIfNotOverridden();
    updatePaymentCalcs();
  }
}

function goBack(){
  document.getElementById("globalCard").scrollIntoView({behavior:"smooth"});
}

/* =========================
   Reset tables
========================= */
function resetClientsTable(){
  const ok = confirm(
    "Are you sure?\n\nThis will delete ALL Clients records and remove the Client ID list used in Order/Payment."
  );
  if(!ok) return;
  state.clients = [];
  saveState();
  renderAll();
  rebuildClientIdDatalist();
}
function resetOrdersTable(){
  const ok = confirm("Are you sure you want to delete ALL Orders records?");
  if(!ok) return;
  state.orders = [];
  saveState();
  renderAll();
}
function resetPaymentsTable(){
  const ok = confirm("Are you sure you want to delete ALL Payments records?");
  if(!ok) return;
  state.sales = [];
  saveState();
  renderAll();
}

/* =========================
   Render Tables
========================= */
function createDeleteBtn(onClick){
  const btn = document.createElement("button");
  btn.textContent = "Delete";
  btn.className = "btn-secondary";
  btn.style.padding = "6px 10px";
  btn.style.borderRadius = "14px";
  btn.addEventListener("click", onClick);
  return btn;
}
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function renderClients(){
  const tbody = document.querySelector("#clientsTable tbody");
  tbody.innerHTML = "";
  state.clients.forEach((c, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.date}</td>
      <td>${escapeHtml(c.seName)}</td>
      <td>${escapeHtml(c.clientId)}</td>
      <td>${escapeHtml(c.clientName)}</td>
      <td>${escapeHtml(c.clientType)}</td>
      <td>${escapeHtml(c.level)}</td>
      <td>${escapeHtml(c.district)}</td>
      <td>${escapeHtml(c.parish)}</td>
      <td>${escapeHtml(c.contact || "")}</td>
      <td>${escapeHtml(c.status || "")}</td>
      <td>${escapeHtml(c.enrollmentDate || "")}</td>
      <td></td>
    `;
    tr.querySelector("td:last-child").appendChild(createDeleteBtn(() => {
      state.clients.splice(idx, 1);
      saveState();
      renderAll();
      rebuildClientIdDatalist();
    }));
    tbody.appendChild(tr);
  });
}

function renderOrders(){
  const tbody = document.querySelector("#ordersTable tbody");
  tbody.innerHTML = "";
  state.orders.forEach((o, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${o.date}</td>
      <td>${escapeHtml(o.seName)}</td>
      <td>${escapeHtml(o.clientId)}</td>
      <td></td>
      <td></td>
      <td>${escapeHtml(o.dateOfOrder)}</td>
      <td>${escapeHtml(o.dateOfDelivery)}</td>
      <td>${escapeHtml(o.timeOfDelivery || "")}</td>
      <td>${escapeHtml(o.location)}</td>
      <td>${escapeHtml(o.product)}</td>
      <td>${escapeHtml(String(o.quantity))}</td>
      <td>${escapeHtml(String(o.unitPrice ?? ""))}</td>
      <td>${escapeHtml(String(o.discountType ?? ""))}</td>
      <td>${escapeHtml(String(o.discountPct ?? ""))}</td>
      <td>${escapeHtml(String(o.discountUgx ?? ""))}</td>
      <td></td>
    `;
    tr.querySelector("td:last-child").appendChild(createDeleteBtn(() => {
      state.orders.splice(idx, 1);
      saveState();
      renderAll();
    }));
    tbody.appendChild(tr);
  });
}

function renderPayments(){
  const tbody = document.querySelector("#paymentsTable tbody");
  tbody.innerHTML = "";
  state.sales.forEach((p, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.seName)}</td>
      <td>${p.date}</td>
      <td>${escapeHtml(p.clientId)}</td>
      <td>${escapeHtml(p.orderNumber || "")}</td>
      <td>${escapeHtml(p.product)}</td>
      <td>${escapeHtml(String(p.unitPrice))}</td>
      <td>${escapeHtml(String(p.qtyKg))}</td>
      <td>${escapeHtml(String(p.qtyPortion))}</td>
      <td>${escapeHtml(String(p.expected))}</td>
      <td>${escapeHtml(String(p.actual))}</td>
      <td>${escapeHtml(String(p.discrepancy))}</td>
      <td>${escapeHtml(p.comment || "")}</td>
      <td></td>
    `;
    tr.querySelector("td:last-child").appendChild(createDeleteBtn(() => {
      state.sales.splice(idx, 1);
      saveState();
      renderAll();
    }));
    tbody.appendChild(tr);
  });
}

function renderAll(){
  renderClients();
  renderOrders();
  renderPayments();
}

/* =========================
   Export XLSX (3 sheets)
========================= */
function exportXLSX(){
  setText("formError", "");
  setText("formWarn", "");

  if(typeof XLSX === "undefined"){
    setText("formError", "XLSX library not loaded. Open the app once while ONLINE (first load), then try Export again.");
    return;
  }

  const wb = XLSX.utils.book_new();

  const clientsRows = state.clients.map(c => ({
    Date: c.date,
    "SE Name": c.seName,
    "Client ID": c.clientId,
    "Client name": c.clientName,
    "Client type": c.clientType,
    Level: c.level,
    District: c.district,
    Parish: c.parish,
    Contact: c.contact || "",
    Status: c.status || "",
    "Enrollment date": c.enrollmentDate || ""
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(clientsRows), "Clients");

  const ordersRows = state.orders.map(o => ({
    Date: o.date,
    "SE Name": o.seName,
    "Client ID": o.clientId,
    "Blank 1": "",
    "Blank 2": "",
    "Date of order": o.dateOfOrder,
    "Date of delivery": o.dateOfDelivery,
    "Time of delivery": o.timeOfDelivery || "",
    "Location of delivery": o.location,
    "Type of product": o.product,
    Quantity: o.quantity,
    "Unit price (UGX)": o.unitPrice ?? "",
    "Type of discount": o.discountType ?? "",
    "Discount (%)": o.discountPct ?? "",
    "Discount (UGX)": o.discountUgx ?? ""
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(ordersRows), "Orders");

  const paymentsRows = state.sales.map(p => ({
    "SE Name": p.seName,
    Date: p.date,
    "Client ID": p.clientId,
    "Order Number": p.orderNumber || "",
    Product: p.product,
    "Unit Price": p.unitPrice,
    "Qty (kg)": p.qtyKg,
    "Qty (portion)": p.qtyPortion,
    Expected: p.expected,
    Actual: p.actual,
    Discrepancy: p.discrepancy,
    Comment: p.comment || ""
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(paymentsRows), "Payments");

  const date = globalDate.value || todayISO();
  const se = (seName.value.trim() || "SE").replace(/[^a-z0-9_-]+/gi,"_");
  XLSX.writeFile(wb, `${se}_${date}_DailyRecords.xlsx`);
}

/* =========================
   Events
========================= */
mode.addEventListener("change", () => {
  setModeUI();
  setText("formWarn", "");
  setText("formError", "");
});

recordBtn.addEventListener("click", () => {
  setText("formWarn", "");
  setText("formError", "");

  const m = mode.value;
  let err = "";
  if(m === "newClient") err = recordNewClient();
  else if(m === "order") err = recordOrder();
  else err = recordPayment();

  if(err){
    setText("formError", err);
    return;
  }
  setText("formWarn", "Recorded successfully.");
});

resetBtn.addEventListener("click", () => resetForm());
backBtn.addEventListener("click", () => goBack());
exportBtn.addEventListener("click", () => exportXLSX());

resetClientsBtn.addEventListener("click", () => resetClientsTable());
resetOrdersBtn.addEventListener("click", () => resetOrdersTable());
resetPaymentsBtn.addEventListener("click", () => resetPaymentsTable());

// New client reactive
ncDistrict.addEventListener("change", () => { updateParishUI(); updateClientIdPrefix(); });
ncType.addEventListener("change", () => updateClientIdPrefix());
ncIndDigit.addEventListener("change", () => updateClientIdPrefix());
ncLast3.addEventListener("input", () => {
  ncLast3.value = ncLast3.value.replace(/\D/g,"").slice(0,3);
  updateFullClientId();
});

// ORDER reactive
ordClientId.addEventListener("input", () => {
  applyDefaultOrderPriceIfNotOverridden();
  updateOrderDiscountAndSummary("type");
});
ordProduct.addEventListener("change", () => {
  applyDefaultOrderPriceIfNotOverridden();
  updateOrderDiscountAndSummary("type");
});
ordQty.addEventListener("input", () => updateOrderDiscountAndSummary("type"));
ordUnitPrice.addEventListener("input", () => {
  orderPriceOverridden = true;
  updateOrderDiscountAndSummary("type");
});
ordDiscType.addEventListener("change", () => updateOrderDiscountAndSummary("type"));
ordDiscPct.addEventListener("input", () => updateOrderDiscountAndSummary("pct"));
ordDiscUgx.addEventListener("input", () => updateOrderDiscountAndSummary("ugx"));

// PAYMENT reactive
payClientId.addEventListener("input", () => {
  applyDefaultPayPriceIfNotOverridden();
  updatePaymentCalcs();
});
payProduct.addEventListener("change", () => {
  applyDefaultPayPriceIfNotOverridden();
  if(payQtyKg.value !== ""){
    syncPayPortionFromKg();
  }else if(payQtyPortion.value !== ""){
    syncPayKgFromPortion();
  }else{
    updatePaymentCalcs();
  }
});
payUnitPrice.addEventListener("input", () => {
  payPriceOverridden = true;
  updatePaymentCalcs();
});
payQtyKg.addEventListener("input", () => syncPayPortionFromKg());
payQtyPortion.addEventListener("input", () => syncPayKgFromPortion());
payActual.addEventListener("input", () => updatePaymentCalcs());

/* =========================
   Init
========================= */
function init(){
  loadState();

  globalDate.value = todayISO();
  ordDate.value = todayISO();
  ordDeliveryDate.value = todayISO();
  ordDeliveryTime.value = "";

  ncEnrollDate.value = todayISO();

  updateParishUI();
  updateClientIdPrefix();
  updateFullClientId();

  rebuildClientIdDatalist();
  renderAll();

  // ORDER init
  orderPriceOverridden = false;
  ordDiscType.value = "%";
  applyDefaultOrderPriceIfNotOverridden();
  updateOrderDiscountAndSummary("type");

  // PAYMENT init
  payPriceOverridden = false;
  applyDefaultPayPriceIfNotOverridden();
  updatePaymentCalcs();

  setModeUI();

  // Friendly warning if XLSX not loaded yet (offline/blocked first load)
  setTimeout(() => {
    if (typeof XLSX === "undefined") {
      setText("formWarn", "⚠️ XLSX not loaded yet. Open this app once with internet (first load), then Export will work.");
    }
  }, 1200);
}
init();
</script>
</body>
</html>
